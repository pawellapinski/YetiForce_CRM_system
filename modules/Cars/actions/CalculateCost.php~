<?php
// modules/Cars/actions/CalculateCost.php

class Cars_CalculateCost_Action extends \App\Controller\Action
{
    public function checkPermission(\App\Request $request)
    {
        $currentUserPrivilegesModel = Users_Privileges_Model::getCurrentUserPrivilegesModel();
        if (!$currentUserPrivilegesModel->hasModulePermission($request->getModule())) {
            throw new \App\Exceptions\NoPermitted('LBL_PERMISSION_DENIED', 406);
        }
    }

    public function process(\App\Request $request)
    {
        $recordId = $request->getInteger('record');
        $startDate = $request->getByType('startDate', 'Date');
        $endDate = $request->getByType('endDate', 'Date');

        $response = new Vtiger_Response();

        try {
            $departures = (new \App\Db\Query())
                ->select(['kilometers_traveled'])
                ->from('u_yf_departures')
                ->where([
                    'and',
                    ['car' => $recordId],
                    ['between', 'departure_date', $startDate, $endDate]
                ])
                ->all();

            if (empty($departures)) {
                throw new \Exception('No data for calculation in selected period');
            }

            $totalKilometers = array_sum(array_column($departures, 'kilometers_traveled'));

            $carRecord = Vtiger_Record_Model::getInstanceById($recordId, 'Cars');
            $averageFuel = $carRecord->get('average_fuel');

            $cost = ($totalKilometers / 100) * $averageFuel * 5;

            // Update the operating costs
            $carRecord->set('operating_costs', $cost);
            $carRecord->save();

            $response->setResult([
                'success' => true,
                'message' => "Cost calculated successfully: $cost PLN"
            ]);
        } catch (\Exception $e) {
            $response->setError($e->getMessage());
        }

        $response->emit();
    }
}